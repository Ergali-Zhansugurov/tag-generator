from sentence_transformers import SentenceTransformer
import faiss
import numpy as np
from transformers import pipeline

# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
model = SentenceTransformer("all-MiniLM-L6-v2")

# 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤
summarizer = pipeline("summarization", model="facebook/bart-large-cnn")

# 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥ + –æ—Ç–∑—ã–≤—ã
books = [
{
        "title": "–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞",
        "author": "–ú.–ê. –ë—É–ª–≥–∞–∫–æ–≤",
        "description": "–§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–π —Ä–æ–º–∞–Ω –æ –ª—é–±–≤–∏, –¥–æ–±—Ä–µ –∏ –∑–ª–µ.",
        "reviews": [
            "–ù–∞—Å—Ç–æ—è—â–∏–π —à–µ–¥–µ–≤—Ä —Ä—É—Å—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã.",
            "–ë—É–ª–≥–∞–∫–æ–≤ –≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ —Å–º–µ—à–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Ñ–∞–Ω—Ç–∞–∑–∏—é.",
            "–ö–Ω–∏–≥–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—á–µ—Ç—Å—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞ –∏ —Å–Ω–æ–≤–∞."
        ]
    },
    {
        "title": "–£–Ω–µ—Å–µ–Ω–Ω—ã–µ –≤–µ—Ç—Ä–æ–º",
        "author": "–ú–∞—Ä–≥–∞—Ä–µ—Ç –ú–∏—Ç—á–µ–ª–ª",
        "description": "–≠–ø–∏—á–µ—Å–∫–∏–π —Ä–æ–º–∞–Ω –æ –∂–∏–∑–Ω–∏ –Ω–∞ –Æ–≥–µ –°–®–ê –≤–æ –≤—Ä–µ–º—è –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –≤–æ–π–Ω—ã.",
        "reviews": [
            "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ –ª—é–±–≤–∏ –∏ –≤—ã–∂–∏–≤–∞–Ω–∏–∏.",
            "–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –∂–∏–≤—ã–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–µ—Å—è.",
            "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –¥—Ä–∞–º—ã."
        ]
    },
    {
        "title": "–ú–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–∏–Ω—Ü",
        "author": "–ê–Ω—Ç—É–∞–Ω –¥–µ –°–µ–Ω—Ç-–≠–∫–∑—é–ø–µ—Ä–∏",
        "description": "–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è —Å–∫–∞–∑–∫–∞ –æ –ª—é–±–≤–∏ –∏ –¥—Ä—É–∂–±–µ.",
        "reviews": [
            "–ö–Ω–∏–≥–∞, –ø–æ–ª–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç–∏ –∏ —Ç–µ–ø–ª–∞.",
            "–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ç—Ä–æ–≥–∞–µ—Ç —Å–µ—Ä–¥—Ü–µ.",
            "–ö–∞–∂–¥–æ–µ –ø—Ä–æ—á—Ç–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–º—ã—Å–ª—ã."
        ]
    },
    {
        "title": "–¢—Ä–∏ —Ç–æ–≤–∞—Ä–∏—â–∞",
        "author": "–≠—Ä–∏—Ö –ú–∞—Ä–∏—è –†–µ–º–∞—Ä–∫",
        "description": "–†–æ–º–∞–Ω –æ –¥—Ä—É–∂–±–µ –∏ –ª—é–±–≤–∏ –Ω–∞ —Ñ–æ–Ω–µ –ø–æ—Å–ª–µ–≤–æ–µ–Ω–Ω–æ–π –ì–µ—Ä–º–∞–Ω–∏–∏.",
        "reviews": [
            "–ì–ª—É–±–æ–∫–∞—è –∏ —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è.",
            "–†–µ–º–∞—Ä–∫ –º–∞—Å—Ç–µ—Ä—Å–∫–∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —ç–º–æ—Ü–∏–∏ –∏ —á—É–≤—Å—Ç–≤–∞.",
            "–ö–Ω–∏–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–ª—É–±–æ–∫–∏–π —Å–ª–µ–¥ –≤ –¥—É—à–µ."
        ]
    },
    {
        "title": "–ü–æ –∫–æ–º –∑–≤–æ–Ω–∏—Ç –∫–æ–ª–æ–∫–æ–ª",
        "author": "–≠—Ä–Ω–µ—Å—Ç –•–µ–º–∏–Ω–≥—É—ç–π",
        "description": "–†–æ–º–∞–Ω –æ –≤–æ–π–Ω–µ –∏ –ª–∏—á–Ω—ã—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è—Ö.",
        "reviews": [
            "–•–µ–º–∏–Ω–≥—É—ç–π –ø–∏—à–µ—Ç —Å –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —Å–∏–ª–æ–π –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é.",
            "–ö–Ω–∏–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏.",
            "–ò—Å—Ç–æ—Ä–∏—è, –ø–æ–ª–Ω–∞—è –±–æ–ª–∏ –∏ –Ω–∞–¥–µ–∂–¥—ã."
        ]
    },
    {
        "title": "–ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã",
        "author": "–§.–ú. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π",
        "description": "–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ä–æ–º–∞–Ω –æ —Å–µ–º—å–µ, –≤–µ—Ä–µ –∏ –º–æ—Ä–∞–ª–∏.",
        "reviews": [
            "–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –¥—É—à–µ.",
            "–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π –≤ —Å–≤–æ–µ–º –ª—É—á—à–µ–º –ø—Ä–æ—è–≤–ª–µ–Ω–∏–∏.",
            "–ö–Ω–∏–≥–∞, —Ç—Ä–µ–±—É—é—â–∞—è –≤–¥—É–º—á–∏–≤–æ–≥–æ –ø—Ä–æ—á—Ç–µ–Ω–∏—è."
        ]
    },
    {
        "title": "–ì–æ—Ä–¥–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—É–±–µ–∂–¥–µ–Ω–∏–µ",
        "author": "–î–∂–µ–π–Ω –û—Å—Ç–µ–Ω",
        "description": "–†–æ–º–∞–Ω –æ –ª—é–±–≤–∏ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ –≤ –ê–Ω–≥–ª–∏–∏ 19 –≤–µ–∫–∞.",
        "reviews": [
            "–û—Å—Ç–µ–Ω –ø–∏—à–µ—Ç —Å –æ—Å—Ç—Ä–æ—É–º–∏–µ–º –∏ –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.",
            "–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ –ª—é–±–≤–∏ –∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–µ.",
            "–ö–ª–∞—Å—Å–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —Ç–µ—Ä—è–µ—Ç —Å–≤–æ–µ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏."
        ]
    },
    {
        "title": "–°—Ç–æ –ª–µ—Ç –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞",
        "author": "–ì–∞–±—Ä–∏—ç–ª—å –ì–∞—Ä—Å–∏—è –ú–∞—Ä–∫–µ—Å",
        "description": "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–µ–∞–ª–∏–∑–º –æ –∂–∏–∑–Ω–∏ —Å–µ–º—å–∏ –ë—É—ç–Ω–¥–∏–∞.",
        "reviews": [
            "–ú–∞—Å—Ç–µ—Ä—Å–∫–∏ –Ω–∞–ø–∏—Å–∞–Ω–Ω–∞—è —ç–ø–æ–ø–µ—è.",
            "–ú–∞—Ä–∫–µ—Å —Å–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ –∑–∞–≤–æ—Ä–∞–∂–∏–≤–∞—é—â–∏–π –º–∏—Ä.",
            "–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–∞ –º–∞–≥–∏–∏ –∏ —á—É–¥–µ—Å."
        ]
    },
    {
        "title": "–ê–ª—Ö–∏–º–∏–∫",
        "author": "–ü–∞—É–ª–æ –ö–æ—ç–ª—å–æ",
        "description": "–ü—Ä–∏—Ç—á–∞ –æ –ø–æ–∏—Å–∫–µ —Å–≤–æ–µ–π –º–µ—á—Ç—ã –∏ —Å—É–¥—å–±—ã.",
        "reviews": [
            "–ü—Ä–æ—Å—Ç–∞—è, –Ω–æ –≥–ª—É–±–æ–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è.",
            "–ö–æ—ç–ª—å–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å –∑–∞ —Å–≤–æ–∏–º–∏ –º–µ—á—Ç–∞–º–∏.",
            "–ö–Ω–∏–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤–µ—Ä–∏—Ç—å –≤ —á—É–¥–µ—Å–∞."
        ]
    },
    {
        "title": "–£–ª–∏—Å—Å",
        "author": "–î–∂–µ–π–º—Å –î–∂–æ–π—Å",
        "description": "–≠–ø–∏—á–µ—Å–∫–∏–π —Ä–æ–º–∞–Ω –æ –¥–Ω–µ –∏–∑ –∂–∏–∑–Ω–∏ –î—É–±–ª–∏–Ω—Ü–∞.",
        "reviews": [
            "–°–ª–æ–∂–Ω–∞—è, –Ω–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –∫–Ω–∏–≥–∞.",
            "–î–∂–æ–π—Å —Å–æ–∑–¥–∞–µ—Ç –º–∏—Ä, –ø–æ–ª–Ω—ã–π –¥–µ—Ç–∞–ª–µ–π –∏ —Å–º—ã—Å–ª–æ–≤.",
            "–ö–Ω–∏–≥–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ."
        ]
    },
    {
        "title": "–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ",
        "author": "–§.–ú. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π",
        "description": "–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π —Ä–æ–º–∞–Ω –æ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ –º–æ—Ä–∞–ª–∏.",
        "reviews": [
            "–û—á–µ–Ω—å –≥–ª—É–±–æ–∫–∞—è –∫–Ω–∏–≥–∞ –æ —Ç–µ—Ä–∑–∞–Ω–∏—è—Ö –¥—É—à–∏ –∏ –º–æ—Ä–∞–ª—å–Ω–æ–º –≤—ã–±–æ—Ä–µ.",
            "–ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –ø—Ä–∏—Ä–æ–¥–µ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –∏—Å–∫—É–ø–ª–µ–Ω–∏—è.",
            "–ú–µ—Å—Ç–∞–º–∏ —Ç—è–∂—ë–ª–∞—è, –Ω–æ –ø–æ—Å–ª–µ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—Ç."
        ]
    },
    {
        "title": "1984",
        "author": "–î–∂–æ—Ä–¥–∂ –û—Ä—É—ç–ª–ª",
        "description": "–ê–Ω—Ç–∏—É—Ç–æ–ø–∏—è –æ —Ç–æ—Ç–∞–ª–∏—Ç–∞—Ä–Ω–æ–º –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ —Å–æ–∑–Ω–∞–Ω–∏—è.",
        "reviews": [
            "–ü—É–≥–∞—é—â–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∫–Ω–∏–≥–∞, —á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ.",
            "–û—Ä—É—ç–ª–ª –º–∞—Å—Ç–µ—Ä—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –≤–ª–∞—Å—Ç—å –º–∞–Ω–∏–ø—É–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é.",
            "–û—á–µ–Ω—å –º—Ä–∞—á–Ω–∞—è, –Ω–æ –¥–∞—ë—Ç –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É —Å–≤–æ–±–æ–¥–∞ —Ç–∞–∫ –≤–∞–∂–Ω–∞."
        ]
    }
]

# 4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–∑—ã–≤—ã ‚Äì —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è
def process_reviews(reviews, max_summary_length=50):
    text = " ".join(reviews)  # –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã
    summary = summarizer(text, max_length=max_summary_length, min_length=20, do_sample=False)
    return summary[0]["summary_text"]

for book in books:
    book["summary_reviews"] = process_reviews(book["reviews"])

# 5. –í–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º –∫–Ω–∏–≥–∏ —Å —É—á—ë—Ç–æ–º –æ—Ç–∑—ã–≤–æ–≤
descriptions = [book["description"] + " " + book["summary_reviews"] for book in books]
book_embeddings = model.encode(descriptions)

# 6. –°–æ–∑–¥–∞—ë–º Faiss-–∏–Ω–¥–µ–∫—Å
index = faiss.IndexFlatL2(book_embeddings.shape[1])
index.add(np.array(book_embeddings, dtype=np.float32))

# 7. –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
def find_similar_books(query, top_n=3):
    query_embedding = model.encode([query])
    distances, indices = index.search(np.array(query_embedding, dtype=np.float32), top_n)
    return [books[i] for i in indices[0]]

# 8. –¢–µ—Å—Ç–∏—Ä—É–µ–º
query = "—Ö–æ—á—É –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –æ—Ç –∫–æ—Ç–æ—Ä–æ–π —è –∑–∞–¥—É–º–∞—é—Å—å"
results = find_similar_books(query)

for book in results:
    print(f"üìñ {book['title']} - {book['author']}")
